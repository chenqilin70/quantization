<?xml version="1.0" encoding="UTF-8"?>
<sqls>
    <!--
        clrq在2年以上的gp型jj与各主流index的相关系数
    -->
    <corr regist="index,netval,fund">
        <![CDATA[
            (
                select
                    substring_index(n.rowkey,"_",1) as fundcode,
                    substr(i.rowkey,1,instr(i.rowkey,"_")-1) indexcode,
                    corr(i.close,n.LJJZ) as correlationindex,0 as corrtype
                from
                    index i
                    inner join netval n on substr(i.rowkey,instr(i.rowkey,"_")+1)=substr(n.rowkey,instr(n.rowkey,"_")+1)
                    inner join fund f on f.fundcode=substr(n.rowkey,1,instr(n.rowkey,"_")-1)
                where
                    i.close is not null
                    and n.LJJZ is not null
                    and (
                        f.jjlx='股票型'
                        or f.jjlx='股票指数'
                        or f.jjlx='联接基金'
                    )
                    and f.fxrq is not null
                    and add_months(now(),0-(2*12)) >= to_date(regexp_replace(regexp_replace(f.fxrq,'年|月','-'),'日',''))
                group by
                    substring_index(n.rowkey,"_",1),
                    substr(i.rowkey,1,instr(i.rowkey,"_")-1)
                having
                    correlationindex is not null
                order by
                    fundcode,correlationindex
            )union all
            (
                select
                    substring_index(n.rowkey,"_",1) as fundcode,
                    substr(i.rowkey,1,instr(i.rowkey,"_")-1) indexcode,
                    corr(i.close,n.LJJZ) as correlationindex,1 as corrtype
                from
                    index i
                    inner join netval n on substr(i.rowkey,instr(i.rowkey,"_")+1)=substr(n.rowkey,instr(n.rowkey,"_")+1)
                    inner join fund f on f.fundcode=substr(n.rowkey,1,instr(n.rowkey,"_")-1)
                where
                    i.close is not null
                    and n.LJJZ is not null
                    and (
                        f.jjlx='股票型'
                        or f.jjlx='股票指数'
                        or f.jjlx='联接基金'
                    )
                    and f.fxrq is not null
                    and add_months(now(),0-(2*12)) >= to_date(regexp_replace(regexp_replace(f.fxrq,'年|月','-'),'日',''))
                    and add_months(now(),-1) <= to_date(
                        concat(
                            substr(n.rowkey,instr(n.rowkey,"_")+1,4),'-',
                            substr(n.rowkey,instr(n.rowkey,"_")+5,2),'-',
                            substr(n.rowkey,instr(n.rowkey,"_")+7,2)
                        )
                    )
                    and add_months(now(),-1) <= to_date(
                        concat(
                            substr(i.rowkey,instr(i.rowkey,"_")+1,4),'-',
                            substr(i.rowkey,instr(i.rowkey,"_")+5,2),'-',
                            substr(i.rowkey,instr(i.rowkey,"_")+7,2)
                        )
                    )
                group by
                    substring_index(n.rowkey,"_",1),
                    substr(i.rowkey,1,instr(i.rowkey,"_")-1)
                having
                    correlationindex is not null
                order by
                    fundcode,correlationindex
            )union all
            (
                select
                    substring_index(n.rowkey,"_",1) as fundcode,
                    substr(i.rowkey,1,instr(i.rowkey,"_")-1) indexcode,
                    corr(i.close,n.LJJZ) as correlationindex,3 as corrtype
                from
                    index i
                    inner join netval n on substr(i.rowkey,instr(i.rowkey,"_")+1)=substr(n.rowkey,instr(n.rowkey,"_")+1)
                    inner join fund f on f.fundcode=substr(n.rowkey,1,instr(n.rowkey,"_")-1)
                where
                    i.close is not null
                    and n.LJJZ is not null
                    and (
                        f.jjlx='股票型'
                        or f.jjlx='股票指数'
                        or f.jjlx='联接基金'
                    )
                    and f.fxrq is not null
                    and add_months(now(),0-(2*12)) >= to_date(regexp_replace(regexp_replace(f.fxrq,'年|月','-'),'日',''))
                    and add_months(now(),-3) <= to_date(
                        concat(
                            substr(n.rowkey,instr(n.rowkey,"_")+1,4),'-',
                            substr(n.rowkey,instr(n.rowkey,"_")+5,2),'-',
                            substr(n.rowkey,instr(n.rowkey,"_")+7,2)
                        )
                    )
                    and add_months(now(),-3) <= to_date(
                        concat(
                            substr(i.rowkey,instr(i.rowkey,"_")+1,4),'-',
                            substr(i.rowkey,instr(i.rowkey,"_")+5,2),'-',
                            substr(i.rowkey,instr(i.rowkey,"_")+7,2)
                        )
                    )
                group by
                    substring_index(n.rowkey,"_",1),
                    substr(i.rowkey,1,instr(i.rowkey,"_")-1)
                having
                    correlationindex is not null
                order by
                    fundcode,correlationindex
            )union all
            (
                select
                    substring_index(n.rowkey,"_",1) as fundcode,
                    substr(i.rowkey,1,instr(i.rowkey,"_")-1) indexcode,
                    corr(i.close,n.LJJZ) as correlationindex,6 as corrtype
                from
                    index i
                    inner join netval n on substr(i.rowkey,instr(i.rowkey,"_")+1)=substr(n.rowkey,instr(n.rowkey,"_")+1)
                    inner join fund f on f.fundcode=substr(n.rowkey,1,instr(n.rowkey,"_")-1)
                where
                    i.close is not null
                    and n.LJJZ is not null
                    and (
                        f.jjlx='股票型'
                        or f.jjlx='股票指数'
                        or f.jjlx='联接基金'
                    )
                    and f.fxrq is not null
                    and add_months(now(),0-(2*12)) >= to_date(regexp_replace(regexp_replace(f.fxrq,'年|月','-'),'日',''))
                    and add_months(now(),-6) <= to_date(
                        concat(
                            substr(n.rowkey,instr(n.rowkey,"_")+1,4),'-',
                            substr(n.rowkey,instr(n.rowkey,"_")+5,2),'-',
                            substr(n.rowkey,instr(n.rowkey,"_")+7,2)
                        )
                    )
                    and add_months(now(),-6) <= to_date(
                        concat(
                            substr(i.rowkey,instr(i.rowkey,"_")+1,4),'-',
                            substr(i.rowkey,instr(i.rowkey,"_")+5,2),'-',
                            substr(i.rowkey,instr(i.rowkey,"_")+7,2)
                        )
                    )
                group by
                    substring_index(n.rowkey,"_",1),
                    substr(i.rowkey,1,instr(i.rowkey,"_")-1)
                having
                    correlationindex is not null
                order by
                    fundcode,correlationindex
            )union all
            (
                select
                    substring_index(n.rowkey,"_",1) as fundcode,
                    substr(i.rowkey,1,instr(i.rowkey,"_")-1) indexcode,
                    corr(i.close,n.LJJZ) as correlationindex,12 as corrtype
                from
                    index i
                    inner join netval n on substr(i.rowkey,instr(i.rowkey,"_")+1)=substr(n.rowkey,instr(n.rowkey,"_")+1)
                    inner join fund f on f.fundcode=substr(n.rowkey,1,instr(n.rowkey,"_")-1)
                where
                    i.close is not null
                    and n.LJJZ is not null
                    and (
                        f.jjlx='股票型'
                        or f.jjlx='股票指数'
                        or f.jjlx='联接基金'
                    )
                    and f.fxrq is not null
                    and add_months(now(),0-(2*12)) >= to_date(regexp_replace(regexp_replace(f.fxrq,'年|月','-'),'日',''))
                    and add_months(now(),-12) <= to_date(
                        concat(
                            substr(n.rowkey,instr(n.rowkey,"_")+1,4),'-',
                            substr(n.rowkey,instr(n.rowkey,"_")+5,2),'-',
                            substr(n.rowkey,instr(n.rowkey,"_")+7,2)
                        )
                    )
                    and add_months(now(),-12) <= to_date(
                        concat(
                            substr(i.rowkey,instr(i.rowkey,"_")+1,4),'-',
                            substr(i.rowkey,instr(i.rowkey,"_")+5,2),'-',
                            substr(i.rowkey,instr(i.rowkey,"_")+7,2)
                        )
                    )
                group by
                    substring_index(n.rowkey,"_",1),
                    substr(i.rowkey,1,instr(i.rowkey,"_")-1)
                having
                    correlationindex is not null
                order by
                    fundcode,correlationindex
            )
        ]]>
    </corr>
    <gzbd regist="fund">
        <![CDATA[
            select
                split(f.yjbjjz,'[+]')
            from
                fund f
            where
                f.jjlx='债券型'
        ]]>
    </gzbd>
    <kernal regist="fund">
        <![CDATA[
            select
                cast(regexp_replace(f.zcgm,'（.+）|,|亿元','') as double)
            from
                fund f
            where
                f.zcgm is not null
                and f.zcgm !='---'
        ]]>
    </kernal>
    <movingAverages regist="netval,fund">
        <![CDATA[
            select
                *
            from(
                select
                    f.fundcode,n.FSRQ,n.LJJZ
                    Row_Number() OVER   (partition by f.fundcode order by to_date(n.FSRQ) desc) as rank
                from
                    fund f
                    left join netval n on f.fundcode=substr(n.rowkey,1,instr(n.rowkey,"_")-1)
                where
                    f.jjlx='混合型'
                ) a
            where
                a.rank<10

        ]]>
    </movingAverages>

</sqls>